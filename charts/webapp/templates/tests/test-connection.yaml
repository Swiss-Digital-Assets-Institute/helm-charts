apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Values.name }}-test-connection"
  namespace: {{ include "namespace" . }}
  labels:
    {{- include "webapp.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  securityContext:
    {{- toYaml .Values.testConnection.podSecurityContext | nindent 4 }}
  containers:
    - name: wget
      image: "{{ .Values.testConnection.image.repository }}:{{ .Values.testConnection.image.tag }}"
      imagePullPolicy: {{ .Values.testConnection.image.pullPolicy }}
      command: ["/bin/sh"]
      args:
        - -c
        - wget -q -O - {{ include "webapp.name" . }}:{{ .Values.container.port }} >/dev/null
      securityContext:
        {{- toYaml .Values.testConnection.securityContext | nindent 8 }}
      readinessProbe:
        exec:
          command:
            - /bin/sh
            - -c
            - wget -q -O - {{ include "webapp.name" . }}:{{ .Values.container.port }} >/dev/null
        initialDelaySeconds: 2
        timeoutSeconds: 3
        periodSeconds: 10
        failureThreshold: 3
        successThreshold: 1
      resources:
        {{- toYaml .Values.testConnection.resources | nindent 8 }}
  restartPolicy: Never
