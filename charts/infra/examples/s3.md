# S3 Bucket Examples

Examples of S3 bucket configurations with lifecycle rules, CORS, website hosting,
versioning, public access block, server-side encryption, and bucket policy settings.

---

## Full S3 configuration with all features

```yaml
aws:
  enabled: true
  region: us-west-1
  providerConfigRef:
    name: aws-provider-config
  s3:
    enabled: true
    bucketNameOverride: ""
    objectOwnership: "BucketOwnerEnforced"

    lifeCycleConfiguration:
      enabled: true
      rule:
        # Rule 1: Transition objects to different storage classes
        - id: transition-to-glacier
          status: Enabled
          filter:
            prefix: logs/
          transition:
            - days: 30
              storageClass: STANDARD_IA
            - days: 90
              storageClass: GLACIER
            - days: 180
              storageClass: DEEP_ARCHIVE

        # Rule 2: Expire old objects
        - id: expire-old-files
          status: Enabled
          filter:
            prefix: temp/
          expiration:
            days: 7

        # Rule 3: Delete incomplete multipart uploads
        - id: cleanup-incomplete-uploads
          status: Enabled
          abortIncompleteMultipartUpload:
            daysAfterInitiation: 7

        # Rule 4: Expire objects with specific tags
        - id: expire-tagged-objects
          status: Enabled
          filter:
            tag:
              - key: Environment
                value: Development
          expiration:
            days: 30

        # Rule 5: Transition and expire with multiple filters
        - id: archive-old-backups
          status: Enabled
          filter:
            and:
              prefix: backups/
              tag:
                - key: Type
                  value: Backup
          transition:
            - days: 60
              storageClass: GLACIER
          expiration:
            days: 365

        # Rule 6: Expire non-current versions (for versioned buckets)
        - id: expire-old-versions
          status: Enabled
          noncurrentVersionExpiration:
            noncurrentDays: 90
          noncurrentVersionTransition:
            - noncurrentDays: 30
              storageClass: STANDARD_IA

        # Rule 7: Expire objects by date
        - id: expire-by-date
          status: Enabled
          filter:
            prefix: reports/2024/
          expiration:
            date: "2025-12-31T00:00:00Z"

    versioning:
      enabled: false

    corsConfiguration:
      enabled: true
      corsRules:
        - allowedHeaders:
            - '*'
          allowedMethods:
            - PUT
            - POST
          allowedOrigins:
            - https://s3-website-test.hashicorp.com
          exposeHeaders:
            - ETag
          maxAgeSeconds: 3000
        - allowedMethods:
            - GET
          allowedOrigins:
            - '*'

    bucketWebsiteConfiguration:
      enabled: true
      errorDocument:
        key: error.html
      indexDocument:
        suffix: index.html
      routingRules:
        - condition:
            keyPrefixEquals: docs/
          redirect:
            replaceKeyPrefixWith: documents/

    bucketPublicAccessBlock:
      enabled: true
      blockPublicAcls: false
      blockPublicPolicy: false
      ignorePublicAcls: false
      restrictPublicBuckets: false

    encryption:
      enabled: true
      type: "AES256"    # Default AES256 encryption

    bucketPolicy:
      enabled: false
```

---

## S3 Bucket Encryption with AES256 (default)

When encryption is enabled without specifying a type (or with `type: "AES256"`), the bucket
will use AES256 server-side encryption by default.

```yaml
aws:
  enabled: true
  region: us-west-1
  s3:
    enabled: true
    encryption:
      enabled: true
      type: "AES256"
```

---

## S3 Bucket Encryption with KMS

To use KMS encryption, set `type` to `"KMS"` and provide the KMS Key ID (ARN or Key ID).

```yaml
aws:
  enabled: true
  region: us-west-1
  s3:
    enabled: true
    encryption:
      enabled: true
      type: "KMS"
      kmsKeyId: "arn:aws:kms:us-west-1:123456789012:key/abcd1234-5678-90ab-cdef-example11111"
```

---

## S3 Bucket Policy

Enable a custom bucket policy by providing the policy document in YAML format.
The chart will automatically convert it to JSON when creating the Crossplane `BucketPolicy` resource.

```yaml
aws:
  enabled: true
  region: us-west-1
  s3:
    enabled: true
    bucketPolicy:
      enabled: true
      policy:
        Version: "2012-10-17"
        Statement:
          - Sid: "AllowPublicRead"
            Effect: "Allow"
            Principal: "*"
            Action:
              - "s3:GetObject"
            Resource:
              - "arn:aws:s3:::my-bucket-name/*"
          - Sid: "DenyInsecureTransport"
            Effect: "Deny"
            Principal: "*"
            Action:
              - "s3:*"
            Condition:
              Bool:
                "aws:SecureTransport": "false"
            Resource:
              - "arn:aws:s3:::my-bucket-name"
              - "arn:aws:s3:::my-bucket-name/*"
```

---

## S3 Bucket with KMS Encryption and Bucket Policy

A combined example enabling KMS encryption alongside a bucket policy.

```yaml
aws:
  enabled: true
  region: us-west-1
  s3:
    enabled: true
    encryption:
      enabled: true
      type: "KMS"
      kmsKeyId: "arn:aws:kms:us-west-1:123456789012:key/abcd1234-5678-90ab-cdef-example11111"
    bucketPolicy:
      enabled: true
      policy:
        Version: "2012-10-17"
        Statement:
          - Sid: "DenyUnencryptedObjectUploads"
            Effect: "Deny"
            Principal: "*"
            Action:
              - "s3:PutObject"
            Condition:
              StringNotEquals:
                "s3:x-amz-server-side-encryption": "aws:kms"
            Resource:
              - "arn:aws:s3:::my-bucket-name/*"
```
