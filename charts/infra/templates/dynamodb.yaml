{{- if and .Values.aws.dynamodb.enabled (default true .Values.aws.enabled) }}
{{ include "infra.checkAwsMandates" . }}
{{- range .Values.aws.dynamodb.tables }}
---
apiVersion: {{ include "infra.dynamodbApiVersion" $ }}
kind: Table
metadata:
  name: {{ .nameOverride | default .name }}
  namespace: {{ $.Release.Namespace }}
  annotations:
    crossplane.io/external-name: {{ .nameOverride | default .name }}
  labels:
    app.kubernetes.io/name: {{ include "infra.releaseName" $ }}
    app.kubernetes.io/instance: {{ include "infra.releaseName" $ }}
    app.kubernetes.io/version: {{ $.Chart.AppVersion | quote }}
    app.kubernetes.io/managed-by: {{ $.Release.Service | quote }}
    helm.sh/chart: {{ printf "%s-%s" $.Chart.Name ($.Chart.Version | replace "+" "_") }}
spec:
  deletionPolicy: {{ .deletionPolicy | default "Delete" | quote }}
  forProvider:
    region: {{ $.Values.aws.region | quote }}

    # KEYS & ATTRIBUTES
    {{- if .attribute }}
    attribute:
{{ toYaml .attribute | indent 6 }}
    {{- end }}
    {{- if .hashKey }}
    hashKey: {{ .hashKey | quote }}
    {{- end }}
    {{- if .rangeKey }}
    rangeKey: {{ .rangeKey | quote }}
    {{- end }}

    # BILLING MODE
    billingMode: {{ .billingMode | default "PAY_PER_REQUEST" | quote }}

    # PROVISIONED THROUGHPUT (only for PROVISIONED billing mode)
    {{- $billingMode := .billingMode | default "PAY_PER_REQUEST" }}
    {{- if eq $billingMode "PROVISIONED" }}
      {{- if .readCapacity }}
    readCapacity: {{ .readCapacity | int }}
      {{- end }}
      {{- if .writeCapacity }}
    writeCapacity: {{ .writeCapacity | int }}
      {{- end }}
    {{- end }}

    # ON-DEMAND THROUGHPUT (only for PAY_PER_REQUEST billing mode)
    {{- if eq $billingMode "PAY_PER_REQUEST" }}
      {{- if .onDemandThroughput }}
    onDemandThroughput:
        {{- if .onDemandThroughput.maxReadRequestUnits }}
      maxReadRequestUnits: {{ .onDemandThroughput.maxReadRequestUnits | int }}
        {{- end }}
        {{- if .onDemandThroughput.maxWriteRequestUnits }}
      maxWriteRequestUnits: {{ .onDemandThroughput.maxWriteRequestUnits | int }}
        {{- end }}
      {{- end }}
    {{- end }}

    # GLOBAL SECONDARY INDEXES
    {{- if .globalSecondaryIndex }}
      {{- if and (default false .globalSecondaryIndex.enabled) .globalSecondaryIndex.indexes }}
    globalSecondaryIndex:
        {{- range .globalSecondaryIndex.indexes }}
        - name: {{ .name | quote }}
          hashKey: {{ .hashKey | quote }}
          {{- if .rangeKey }}
          rangeKey: {{ .rangeKey | quote }}
          {{- end }}
          {{- if .projectionType }}
          projectionType: {{ .projectionType | quote }}
          {{- end }}
          {{- if .nonKeyAttributes }}
          nonKeyAttributes:
{{ toYaml .nonKeyAttributes | indent 12 }}
          {{- end }}
          {{- if eq $billingMode "PROVISIONED" }}
            {{- if .readCapacity }}
          readCapacity: {{ .readCapacity | int }}
            {{- end }}
            {{- if .writeCapacity }}
          writeCapacity: {{ .writeCapacity | int }}
            {{- end }}
          {{- else if .onDemandThroughput }}
          onDemandThroughput:
            {{- if .onDemandThroughput.maxReadRequestUnits }}
            maxReadRequestUnits: {{ .onDemandThroughput.maxReadRequestUnits | default 500 | int }}
            {{- end }}
            {{- if .onDemandThroughput.maxWriteRequestUnits }}
            maxWriteRequestUnits: {{ .onDemandThroughput.maxWriteRequestUnits | default 200 | int }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    # LOCAL SECONDARY INDEXES
    {{- if .localSecondaryIndex }}
      {{- if and (default false .localSecondaryIndex.enabled) .localSecondaryIndex.indexes }}
    localSecondaryIndex:
        {{- range .localSecondaryIndex.indexes }}
        - name: {{ .name | quote }}
          rangeKey: {{ .rangeKey | quote }}
          {{- if .projectionType }}
          projectionType: {{ .projectionType | quote }}
          {{- end }}
          {{- if .nonKeyAttributes }}
          nonKeyAttributes:
{{ toYaml .nonKeyAttributes | indent 12 }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    # DELETION PROTECTION
    deletionProtectionEnabled: {{ .deletionProtectionEnabled | default true }}

    # TABLE CLASS
    tableClass: {{ .tableClass | default "STANDARD" | quote }}

    # SERVER-SIDE ENCRYPTION
    {{- if .serverSideEncryption }}
      {{- if and (default false .serverSideEncryption.enabled) (or .serverSideEncryption.kmsKeyArn (default false .serverSideEncryption.enabled)) }}
    serverSideEncryption:
      enabled: {{ .serverSideEncryption.enabled | default false }}
      {{- if .serverSideEncryption.kmsKeyArn }}
      kmsKeyArn: {{ .serverSideEncryption.kmsKeyArn | quote }}
      {{- end }}
      {{- end }}
    {{- end }}

    # DYNAMODB STREAMS
    {{- if .streamSpecification }}
      {{- if default false .streamSpecification.enabled }}
    streamSpecification:
        {{- if .streamSpecification.streamViewType }}
      streamViewType: {{ .streamSpecification.streamViewType | default "NEW_AND_OLD_IMAGES" | quote }}
        {{- end }}
      {{- end }}
    {{- else if default false .streamEnabled }}
    streamEnabled: {{ .streamEnabled }}
      {{- if .streamViewType }}
    streamViewType: {{ .streamViewType | default "NEW_AND_OLD_IMAGES" | quote }}
      {{- end }}
    {{- end }}

    # TIME-TO-LIVE SPECIFICATION
    {{- if .timeToLiveSpecification }}
      {{- if and (default false .timeToLiveSpecification.enabled) .timeToLiveSpecification.attributeName }}
    timeToLiveSpecification:
      attributeName: {{ .timeToLiveSpecification.attributeName | quote }}
      enabled: {{ .timeToLiveSpecification.enabled }}
      {{- end }}
    {{- else if .ttl }}
      {{- if and (default false .ttl.enabled) .ttl.attributeName }}
    ttl:
      attributeName: {{ .ttl.attributeName | quote }}
      enabled: {{ .ttl.enabled }}
      {{- end }}
    {{- end }}

    # POINT-IN-TIME RECOVERY
    {{- if .pointInTimeRecovery }}
      {{- if default false .pointInTimeRecovery.enabled }}
    pointInTimeRecovery:
      enabled: {{ .pointInTimeRecovery.enabled }}
      {{- end }}
    {{- end }}

    # GLOBAL TABLE REPLICAS
    {{- if .replica }}
      {{- if and (default false .replica.enabled) .replica.regions }}
    replica:
        {{- range .replica.regions }}
        - regionName: {{ .regionName | quote }}
          {{- if .propagateTags }}
          propagateTags: {{ .propagateTags }}
          {{- end }}
          {{- if .pointInTimeRecovery }}
          pointInTimeRecovery: {{ .pointInTimeRecovery }}
          {{- end }}
          {{- if .kmsKeyArn }}
          kmsKeyArn: {{ .kmsKeyArn | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    # RESTORE OPTIONS
    {{- if .restoreOptions }}
      {{- if default false .restoreOptions.enabled }}
        {{- if .restoreOptions.useLatestRestorableTime }}
    restoreToLatestTime: {{ .restoreOptions.useLatestRestorableTime }}
        {{- end }}
        {{- if .restoreOptions.restoreDateTime }}
    restoreDateTime: {{ .restoreOptions.restoreDateTime | quote }}
        {{- end }}
        {{- if .restoreOptions.sourceTableArn }}
    restoreSourceTableArn: {{ .restoreOptions.sourceTableArn | quote }}
        {{- end }}
      {{- end }}
    {{- end }}

    # IMPORT FROM S3
    {{- if .importTable }}
      {{- if default false .importTable.enabled }}
    importTable:
        {{- if .importTable.inputFormat }}
      inputFormat: {{ .importTable.inputFormat | quote }}
        {{- end }}
        {{- if .importTable.inputCompressionType }}
      inputCompressionType: {{ .importTable.inputCompressionType | quote }}
        {{- end }}
        {{- if .importTable.inputFormatOptions }}
      inputFormatOptions:
{{ toYaml .importTable.inputFormatOptions | indent 8 }}
        {{- end }}
        {{- if .importTable.s3BucketSource }}
      s3BucketSource:
          {{- if .importTable.s3BucketSource.bucket }}
        bucket: {{ .importTable.s3BucketSource.bucket | quote }}
          {{- end }}
          {{- if .importTable.s3BucketSource.bucketOwner }}
        bucketOwner: {{ .importTable.s3BucketSource.bucketOwner | quote }}
          {{- end }}
          {{- if .importTable.s3BucketSource.keyPrefix }}
        keyPrefix: {{ .importTable.s3BucketSource.keyPrefix | quote }}
          {{- end }}
        {{- end }}
        {{- if .importTable.tableCreationParameters }}
      tableCreationParameters:
{{ toYaml .importTable.tableCreationParameters | indent 8 }}
        {{- end }}
      {{- end }}
    {{- end }}

    # TAGS
    tags:
{{ include "infra.allTags" (dict "Values" $.Values "section" $.Values.aws.dynamodb) | indent 6 }}

  providerConfigRef:
    name: {{ include "infra.getProviderConfigRefName" (dict "Values" $.Values "section" "dynamodb") | quote }}
{{- end }}
{{- end }}